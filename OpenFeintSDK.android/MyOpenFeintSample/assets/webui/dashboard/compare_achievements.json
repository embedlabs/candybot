{"title":"Compare Achievements","scrolling":true,"loadflow":"var localUserLoaded, localUserReq;\nOF.GA.setAccount('UA-3107048-21', 'spotlight.android.openfeint.com');\n$.loadScript('dashboard/dashboard');\nif ((typeof jasmine !== \"undefined\" && jasmine !== null) && OF.isBrowser) {\n  $.loadCss('settings/spec');\n}\nlocalUserLoaded = localUserReq = null;\nOF.loadLocalUser = function() {\n  if (OF.user.isLoaded) {\n    return typeof localUserLoaded === \"function\" ? localUserLoaded() : void 0;\n  } else {\n    return localUserReq || (localUserReq = OF.api(\"/xp/users/me\", {\n      success: function(userData) {\n        OF.user = userData.user;\n        OF.user.isLoaded = true;\n        if (typeof localUserLoaded === \"function\") {\n          localUserLoaded();\n        }\n        return localUserLoaded = localUserReq = null;\n      }\n    }));\n  }\n};\nOF.localUserLoaded = function(callback) {\n  if (OF.user.isLoaded) {\n    return callback();\n  } else {\n    return localUserLoaded = callback;\n  }\n};","init":"OF.loadLocalUser();\n$('body').addClass('textured');\n$('.button').pretouch();\n\n// Menu handling functions\nif (!OF.menu) {\n  OF.menu = function(buttonName) {\n    if      (buttonName == 'home')      OF.menu.home();\n    else if (buttonName == 'settings')  OF.menu.settings();\n    else if (buttonName == 'exit')      OF.menu.exit();\n    else {\n      OF.log('Unknown menu button hit: '+ buttonName);\n    }\n  };\n  \n  OF.menu.home = function() {\n    if (OF.navigationStack[0].url.match(/dashboard\\/user/)) {\n      OF.goBack({root:true});\n    } else {\n      \n      // This is a bit of a hack for now...\n      OF.navigateToUrl(\"dashboard/user\", {\n        complete: function() {\n          OF.pages.unshift(OF.pages.pop());\n          OF.action('back', {root:true}, OF.contentLoaded);\n        }\n      });\n    }\n  };\n  \n  OF.menu.settings = function() {\n    OF.sendAction('openSettings');\n  };\n  \n  OF.menu.exit = function() {\n    OF.sendAction('dismiss');\n  };\n}\n\n// Base friends page functions\nif (!OF.friendsList) {\n  OF.friendsList = {\n    init: function() {\n      jQuery.lazyLoad({\n        threshold: 0.5,  //percentage of the window height left to scroll that will trigger the next page\n        nextPageLoaded: function(page, data){ \n          if (page == 1) {\n            OF.friendsList.renderFriends(data);                 \n          } else {\n            OF.friendsList.addFriends(data);         \n          }\n        },\n        nextPageShouldLoad: function(page, callback) {\n          OF.api('/xp/friends', {\n            params: {\n              user_id:   OF.page.user.id,\n              page:      page,\n              page_size: 50\n            },\n            success: function(data) {\n              callback(data.users, data.users.length < 50)\n            },\n            failure: function() { callback([]); }\n          });\n        },\n        isEmpty: function() { OF.friendsList.renderFriends([]); },\n        isFinished: function() { jQuery(\"#loading\").hide(); }\n      });\n    },\n    \n    renderFriendItems: function(friends) {\n      var html = jQuery.map(friends, function(friend) {\n       return tmpl('user_tmpl', friend);\n      });\n      return html;\n    },\n    \n    renderFriends : function(friends) {    \n      var html = OF.friendsList.renderFriendItems(friends);\n      \n      if (html.length > 0) {\n        jQuery('#friends_list > ul').html(html.join('')).unhide();\n        jQuery(\"#friends_list .no_data\").hide();\n      } else {\n        jQuery('#friends_list > ul').hide();\n        jQuery(\"#friends_list .no_data\").unhide();      \n      }\n    },\n    \n    addFriends : function(friends) {    \n      var html = OF.friendsList.renderFriendItems(friends);\n      jQuery('#friends_list > ul').append(html.join(''));\n    }\n  };\n}\n\n// Go home on touching the logo area\n$('#home_button').touch(OF.menu.home);\nvar achievementTmpl, game, isAllDataLoaded, me, renderPage, renderUser, them;\n$.loadCss('dashboard/compare_achievements');\n$.loadScript('dashboard/models');\nachievementTmpl = tmpl('compared_achievement_tmpl');\nrenderUser = function(user, elemSelector) {\n  var achievement, achievements, elem, unlockedCount, unlockedPercent, _i, _len;\n  elem = $(elemSelector);\n  if (user.profilePictureUrl) {\n    elem.find('.avatar').css('background-image', \"url(\" + user.profilePictureUrl + \")\");\n  }\n  elem.find('.name').text(user.name);\n  elem.find('.score').text(user.gamerScore);\n  achievements = user.getAchievements(game.id);\n  unlockedCount = 0;\n  for (_i = 0, _len = achievements.length; _i < _len; _i++) {\n    achievement = achievements[_i];\n    if (achievement.achievement.is_unlocked) {\n      unlockedCount++;\n    }\n  }\n  unlockedPercent = Math.round(100 * (unlockedCount / achievements.length));\n  elem.find('.progress').text(\"\" + unlockedPercent + \"%\");\n  elem.find('.ach_bar_percentage').css('width', \"\" + unlockedPercent + \"%\");\n  return elem.touch(function() {\n    OF.GA.page('/webui/dashboard/compare_achievements/tapped_user');\n    return OF.push('dashboard/profile', {\n      params: {\n        user: user.sourceObj\n      }\n    });\n  });\n};\nisAllDataLoaded = function() {\n  return game.loaded && me.loaded && me.getAchievements(game.id) && them.loaded && them.getAchievements(game.id);\n};\nrenderPage = function() {\n  var $achEl, achEl, achID, achievement, html, myUnlocked, obj, theirUnlocked, _i, _len, _ref;\n  if (isAllDataLoaded()) {\n    html = ((function() {\n      var _i, _len, _ref, _results;\n      _ref = me.getAchievements(game.id);\n      _results = [];\n      for (_i = 0, _len = _ref.length; _i < _len; _i++) {\n        achievement = _ref[_i];\n        _results.push(achievementTmpl(achievement.achievement));\n      }\n      return _results;\n    })()).join('');\n    $('#achievement_list').html(html).hide().fadeIn();\n    myUnlocked = (function() {\n      var _i, _len, _ref, _results;\n      _ref = me.getAchievements(game.id);\n      _results = [];\n      for (_i = 0, _len = _ref.length; _i < _len; _i++) {\n        obj = _ref[_i];\n        if (obj.achievement.is_unlocked) {\n          _results.push(obj.achievement.id);\n        }\n      }\n      return _results;\n    })();\n    theirUnlocked = (function() {\n      var _i, _len, _ref, _results;\n      _ref = them.getAchievements(game.id);\n      _results = [];\n      for (_i = 0, _len = _ref.length; _i < _len; _i++) {\n        obj = _ref[_i];\n        if (obj.achievement.is_unlocked) {\n          _results.push(obj.achievement.id);\n        }\n      }\n      return _results;\n    })();\n    _ref = $('li.achievement');\n    for (_i = 0, _len = _ref.length; _i < _len; _i++) {\n      achEl = _ref[_i];\n      $achEl = $(achEl);\n      achID = $achEl.data('achievementid');\n      if (U.include(myUnlocked, achID)) {\n        $achEl.find('.me').addClass('checked');\n      }\n      if (U.include(theirUnlocked, achID)) {\n        $achEl.find('.them').addClass('checked');\n      }\n    }\n    renderUser(me, '#me');\n    renderUser(them, '#them');\n    $('#game .icon').css('background-image', \"url(\" + game.iconUrl + \")\");\n    return $('#game .title').text(game.name);\n  }\n};\ngame = OF.page.params.gameID ? new Game({\n  id: OF.page.params.gameID\n}) : OF.page.params.game ? new Game(OF.page.params.game) : new Game(OF.game);\nif (game.iconUrl && game.title) {\n  game.loaded = true;\n} else {\n  game = Game.find(game.id, renderPage);\n}\nme = null;\nOF.localUserLoaded(function() {\n  me = new User(OF.user);\n  me.loaded = true;\n  return me.getAchievements(game.id, renderPage);\n});\nif (OF.page.params.user) {\n  them = new User(OF.page.params.user);\n  them.loaded = true;\n} else {\n  them = User.find(OF.page.params.userID);\n}\nthem.getAchievements(game.id, renderPage);","resume":null,"appear":"$('#header .title').html(OF.page.title);","disappear":null,"exit":null,"html":"<div id='dashboard'>\n  <div id='header'>\n    <span class='loading'>\n      <span class='spinner'></span>\n    </span>\n    <div class='title' id='home_button'></div>\n  </div>\n  <!--\n    Compare Achievements Page Params:\n    * userID: The id of the user to compare to.\n    * user:   This user object to compare to.  Use this if you have a suer object already loaded form the API.\n    * gameID: The id of the game to compare achievements in. (Defaults to the current game)\n    * game:   The game object of the game to compare achievements in.  Use this if you alreayd have a game object form the API. (Defaults to the current game)\n    Note that a `user` or a `userID` is required, but `game` and `gameID` are optional.\n  -->\n            <script type=\"text/plain\" id=\"compared_achievement_tmpl\">\n              <li class=\"achievement liquid clearfix <%= is_unlocked ? 'unlocked' : 'locked' %>\" data-achievementid=\"<%= id %>\">\n    <div class=\"main\">\n      <div class=\"icon\" style=\"<% if (is_unlocked && icon_url) { %> background-image: url(<%= icon_url %>)<% } %>\">\n        <div class=\"overlay\"></div>\n      </div>\n    \n      <div class=\"title\"><%= is_secret && 0 === percent_complete ? 'Secret' : title %></div>\n      <div class=\"gamerscore\"><%= gamerscore %></div>\n      <div class=\"subtitle\"><%= is_secret && 0 === percent_complete ? 'You must unlock this achievement to view its description.' : description %></div>\n    </div>\n    <div class=\"them\"></div>\n    <div class=\"me\"></div>\n  </li>\n            </script>\n  <div class='compare_achievements' id='achievements'>\n    <section id='game'>\n      <div class='icon'></div>\n      <div class='title'></div>\n    </section>\n    <section id='users'>\n      <h3 class='section_title'>Quick Comparison</h3>\n      <div class='users_row'>\n        <div class='user' id='them'>\n          <div class='inner'>\n            <div class='avatar'>\n              <div class='overlay'></div>\n            </div>\n            <div class='name'></div>\n            <div class='score'></div>\n            <div class='progress'></div>\n            <div class='percent_complete'>\n              <div class='ach_bar_percentage'></div>\n            </div>\n          </div>\n        </div>\n        <div class='user' id='me'>\n          <div class='inner'>\n            <div class='avatar'>\n              <div class='overlay'></div>\n            </div>\n            <div class='name'></div>\n            <div class='score'></div>\n            <div class='progress'></div>\n            <div class='percent_complete'>\n              <div class='ach_bar_percentage'></div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </section>\n    <section id='achievements_section'>\n      <h3 class='section_title'>\n        <div class='main'>Detailed Comparison</div>\n        <div class='them'>Them</div>\n        <div class='me'>You</div>\n      </h3>\n      <ul class='cells' id='achievement_list'>\n        <li class='loading'>\n          <div class='spinner'></div>\n        </li>\n      </ul>\n    </section>\n  </div>\n</div>\n"}