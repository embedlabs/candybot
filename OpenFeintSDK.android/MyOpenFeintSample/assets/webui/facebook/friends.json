{"title":"Feint Friends","scrolling":true,"loadflow":null,"init":"$('body').addClass('textured');\n$('.button').pretouch();\n\n// Parental controls protection\nuserPicUrl = function(url) {\n  if (OF.device.parentalControls) {\n    return 'images/icon.user.male.'+ OF.dpi +'.png';\n  } else {\n    return url;\n  }\n};\n\n// Menu handling functions\nif (!OF.menu) {\n  OF.menu = function(buttonName) {\n    if      (buttonName == 'home')      OF.menu.home();\n    else if (buttonName == 'settings')  OF.menu.settings();\n    else if (buttonName == 'exit')      OF.menu.exit();\n    else {\n      OF.log('Unknown menu button hit: '+ buttonName);\n    }\n  };\n  \n  OF.menu.home = function() {\n    if (OF.navigationStack[0].url.match(/dashboard\\/user/)) {\n      OF.goBack({root:true});\n    } else {\n      OF.navigateToUrl(\"dashboard/user\", {\n        complete: function() {\n          OF.navigationStack = [OF.page];\n          OF.sendAction('back', {root:true});\n        }\n      });\n    }\n  };\n  \n  OF.menu.settings = function() {\n    OF.sendAction('openSettings');\n  };\n  \n  OF.menu.exit = function() {\n    OF.sendAction('dismiss');\n  };\n}\n\n// Base friends page functions\nif (!OF.friendsList) {\n  OF.friendsList = {\n    init: function() {\n      $.lazyLoad({\n        threshold: 0.5,  //percentage of the window height left to scroll that will trigger the next page\n        nextPageLoaded: function(page, data){ \n          if(page == 1) {\n            OF.friendsList.renderFriends(data);                 \n          } else {\n            OF.friendsList.addFriends(data);         \n          }\n        },\n        nextPageShouldLoad: function(page, callback) {\n          OF.api.request('/xp/friends', {\n            params: { user_id: OF.page.user.id, page:page, page_size:50 },\n            success: function(data){ callback(data.users, data.users.length < 50) },\n            failure: function(){ callback([]); }\n          });\n        },\n        isEmpty: function() { OF.friendsList.renderFriends([]); },\n        isFinished: function() { $(\"#loading\").hide(); }\n      });\n    },\n    \n    renderFriendItems: function(friends) {\n      var html = $.map(friends, function(friend) {\n       return tmpl('user_tmpl', friend);\n      });\n      return html;\n    },\n    \n    renderFriends : function(friends) {    \n      var html = OF.friendsList.renderFriendItems(friends);\n      \n      if (html.length > 0) {\n        $('#friends_list > ul').html(html.join('')).unhide();\n        $(\"#friends_list .no_data\").hide();\n      } else {\n        $('#friends_list > ul').hide();\n        $(\"#friends_list .no_data\").unhide();      \n      }\n    },\n    \n    addFriends : function(friends) {    \n      var html = OF.friendsList.renderFriendItems(friends);\n      $('#friends_list > ul').append(html.join(''));\n    }\n  };\n}\n\n// Go home on touching the logo area\n$('#home_button').touch(OF.menu.home);\nvar friendables = [];\nvar users_count = 0;\nvar PENDING_LABEL = 'Pending...';\n\n$('.add_friend_button').touch(function() {\n  OF.GA.page(\"/webui/facebook/friends_addFriend\");\n  this_id = this.id;\n  $(this).text(PENDING_LABEL);\n  $(this).addClass('disabled');\n  OF.api.request('/xp/friend_requests', {\n    background: true,\n    method: 'POST',\n    params: { friend_id: this_id },\n    loader: '#loading .loading',\n    success: function(data) {\n      var index_to_remove = friendables.indexOf(Number(this_id));\n      if (index_to_remove != -1) friendables.splice(index_to_remove, 1);\n      if ((friendables.length < 1) && (users_count > 1)) {\n        $('#add_all_friends_button').addClass('disabled').text(PENDING_LABEL);\n      }\n    }\n  });\n});\n\n$('#add_all_friends_button').touch(function() {\n  OF.GA.page(\"/webui/facebook/friends_addAllFriend?num=\" + friendables.length);\n  $(this).addClass('disabled');\n  if ($(this).text != PENDING_LABEL) {\n    $(this).text('Adding...')\n  }\n  $('.add_friend_button').addClass('disabled').text(PENDING_LABEL)\n  OF.api.request('/xp/facebook/add_friends', {\n    method: 'POST',\n    params: { friend_ids:friendables },\n    loader: '#loading .loading',\n    success: function(data){\n      $('#find_friends').addClass('hidden');\n      $('#all_requests_sent').removeClass('hidden');\n    }\n  });\n});\n\nOF.api.request('/xp/facebook/list', {\n  loader: '#loading .loading',\n  success: function(data) {\n    var userTmpl = tmpl('a_user');\n    var html = [];\n    users_count = data.users.length;\n    \n    if (users_count > 0) {\n      $.each(data.users, function() {\n        html.push(userTmpl(this));\n        friendables.push(this.id);\n      });\n      $('ul#friends_list').append(html.join(\"\"));\n      $('#fb_friend_count_bar').unhide();\n      \n      if (users_count != 1) {\n        $('#facebook_friends_count').html(users_count + ' Friends Using Feint');\n      } else {\n        $('#facebook_friends_count').html('1 Friend Using Feint');\n      }\n      // Hide the all friends button if there are fewer than two friends.\n      if (users_count < 2) {\n        $('#add_all_friends_button').hide();\n      }\n    } else {\n      $('#no_friends_found').unhide();\n    }\n  },\n  \n  failure: function(data, status) {\n  }\n});","resume":null,"appear":"$('#header .title').html(OF.page.title);","disappear":null,"exit":null,"html":"<div id='dashboard'>\n  <div id='header'>\n    <span class='loading'>\n      <span class='spinner'></span>\n    </span>\n    <div class='title' id='home_button'></div>\n  </div>\n            <script type=\"text/plain\" id=\"a_user\">\n              <% var style = \"\"; %>\n  <% if(profile_picture_url){ style = \"background-image: url(\" + userPicUrl(profile_picture_url) + \")\" } %>\n  \n  <li class=\"user\">\n    <div id=\"<%= id %>\" class=\"button add_friend_button\">+ Add</div>\n    <div class=\"image avatar\" style=\"<%= style %>\">\n      <div class=\"overlay\"></div>\n    </div>\n    <div class=\"title feint_name\"><%= feint_name %></div>\n    <div class=\"facebook_name\"><%= facebook_name %></div>\n  </li>\n            </script>\n  <div id='friends'>\n    <section id='find_friends'>\n      <h3 class='section_title'>Facebook Friends</h3>\n      <div class='hidden' id='fb_friend_count_bar'>\n        <div class='cell'>\n          <div class='button' id='add_all_friends_button'>Add All</div>\n          <div class='icon'></div>\n          <div class='content'>\n            <div id='facebook_friends_count'>0</div>\n          </div>\n        </div>\n      </div>\n      <ul class='cells' id='friends_list'></ul>\n      <div class='hidden' id='no_friends_found'>\n        <div class='cell'>\n          We couldn't find any Feint accounts associated with your Facebook friends.  Try searching by their Feint username instead.\n        </div>\n        <div class='cell one_line' data-href='dashboard/user_search'>\n          <div class='icon'></div>\n          <div class='title'>Search by Feint Name</div>\n        </div>\n      </div>\n    </section>\n    <section class='hidden' id='all_requests_sent'>\n      <h3 class='section_title'>Facebook Friends</h3>\n      <div id='all_requests_sent'>\n        <div class='cell'>Your friend requests have been sent!</div>\n      </div>\n    </section>\n    <ul class='cells' id='loading'>\n      <li class='loading'>\n        <div class='spinner'></div>\n      </li>\n    </ul>\n  </div>\n</div>\n"}