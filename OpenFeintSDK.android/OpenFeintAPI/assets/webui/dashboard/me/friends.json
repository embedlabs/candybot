{"title":"Feint Friends","scrolling":true,"loadflow":"var localUserLoaded, localUserReq;\nOF.GA.setAccount('UA-3107048-21', 'spotlight.android.openfeint.com');\n$.loadScript('dashboard/dashboard');\nif ((typeof jasmine !== \"undefined\" && jasmine !== null) && OF.isBrowser) {\n  $.loadCss('settings/spec');\n}\nlocalUserLoaded = localUserReq = null;\nOF.loadLocalUser = function() {\n  if (OF.user.isLoaded) {\n    return typeof localUserLoaded === \"function\" ? localUserLoaded() : void 0;\n  } else {\n    return localUserReq || (localUserReq = OF.api(\"/xp/users/me\", {\n      success: function(userData) {\n        OF.user = userData.user;\n        OF.user.isLoaded = true;\n        if (typeof localUserLoaded === \"function\") {\n          localUserLoaded();\n        }\n        return localUserLoaded = localUserReq = null;\n      }\n    }));\n  }\n};\nOF.localUserLoaded = function(callback) {\n  if (OF.user.isLoaded) {\n    return callback();\n  } else {\n    return localUserLoaded = callback;\n  }\n};","init":"OF.loadLocalUser();\n$('body').addClass('textured');\n$('.button').pretouch();\n\n// Menu handling functions\nif (!OF.menu) {\n  OF.menu = function(buttonName) {\n    if      (buttonName == 'home')      OF.menu.home();\n    else if (buttonName == 'settings')  OF.menu.settings();\n    else if (buttonName == 'exit')      OF.menu.exit();\n    else {\n      OF.log('Unknown menu button hit: '+ buttonName);\n    }\n  };\n  \n  OF.menu.home = function() {\n    if (OF.navigationStack[0].url.match(/dashboard\\/user/)) {\n      OF.goBack({root:true});\n    } else {\n      \n      // This is a bit of a hack for now...\n      OF.navigateToUrl(\"dashboard/user\", {\n        complete: function() {\n          OF.pages.unshift(OF.pages.pop());\n          OF.action('back', {root:true}, OF.contentLoaded);\n        }\n      });\n    }\n  };\n  \n  OF.menu.settings = function() {\n    OF.sendAction('openSettings');\n  };\n  \n  OF.menu.exit = function() {\n    OF.sendAction('dismiss');\n  };\n}\n\n// Base friends page functions\nif (!OF.friendsList) {\n  OF.friendsList = {\n    init: function() {\n      jQuery.lazyLoad({\n        threshold: 0.5,  //percentage of the window height left to scroll that will trigger the next page\n        nextPageLoaded: function(page, data){ \n          if (page == 1) {\n            OF.friendsList.renderFriends(data);                 \n          } else {\n            OF.friendsList.addFriends(data);         \n          }\n        },\n        nextPageShouldLoad: function(page, callback) {\n          OF.api('/xp/friends', {\n            params: {\n              user_id:   OF.page.user.id,\n              page:      page,\n              page_size: 50\n            },\n            success: function(data) {\n              callback(data.users, data.users.length < 50)\n            },\n            failure: function() { callback([]); }\n          });\n        },\n        isEmpty: function() { OF.friendsList.renderFriends([]); },\n        isFinished: function() { jQuery(\"#loading\").hide(); }\n      });\n    },\n    \n    renderFriendItems: function(friends) {\n      var html = jQuery.map(friends, function(friend) {\n       return tmpl('user_tmpl', friend);\n      });\n      return html;\n    },\n    \n    renderFriends : function(friends) {    \n      var html = OF.friendsList.renderFriendItems(friends);\n      \n      if (html.length > 0) {\n        jQuery('#friends_list > ul').html(html.join('')).unhide();\n        jQuery(\"#friends_list .no_data\").hide();\n      } else {\n        jQuery('#friends_list > ul').hide();\n        jQuery(\"#friends_list .no_data\").unhide();      \n      }\n    },\n    \n    addFriends : function(friends) {    \n      var html = OF.friendsList.renderFriendItems(friends);\n      jQuery('#friends_list > ul').append(html.join(''));\n    }\n  };\n}\n\n// Go home on touching the logo area\n$('#home_button').touch(OF.menu.home);\nvar findFriends = OF.page.params.find_friends;\nif (findFriends) {\n  $('#friends_list').hide()\n  $('#friends_tab').removeClass(\"active\");\n  $('#friends_search').removeClass(\"hidden\");\n  $('#find_friends_tab').addClass(\"active\");\n}\n\nOF.page.user = OF.user;\nOF.localUserLoaded(OF.friendsList.init);\nOF.shouldRefreshPage = false;\n\nOF.page.initTabs = function() {\n  $('.tab').touch(function() {\n    $('.tab').removeClass(\"active\");\n    $(this).addClass(\"active\");\n    if (this.id == \"find_friends_tab\") {\n      $('#friends_list').hide();\n      $('#friends_search').unhide();\n    } else {\n      $('#friends_search').hide();\n      $('#friends_list').unhide();\n    }\n  });\n}\nOF.page.initTabs();\n\nOF.page.initRequest = function() {\n  if (OF.user.received_friend_requests_pending_count > 0) {\n    var reqCell = $('#requests');\n    reqCell.find('.title').text(OF.user.received_friend_requests_pending_count + ' Friend Requests');\n    reqCell.unhide();\n  } else {\n    $('#requests').addClass(\"hidden\");\n  }\n}\n\nOF.page.initRequest();\n\nOF.page.reload = function() {\n  $(\"#friends_list > ul\").html(\"\");\n  OF.friendsList.init();\n}\n\nOF.page.facebookDidReturn = function(retval) {\n  OF.api.request(\"/xp/facebook/link\", {\n                   method: \"POST\",\n                   params: { token: retval },\n                   complete: function(retval) {\n                     OF.navigateToUrl(\"facebook/friends\");\n                   }\n                 });\n};\n\nOF.page.facebookDidFailtown = function(errorCode, errorDesc) {\n  OF.log('Facebook fail (' + errorCode + '), \"' + errorDesc + '\"');\n  OF.alert(errorDesc, \"Sorry!  We can't reach Facebook right now.  Please try again later.\");\n};\n\nif (OF.actionIsSupported('openBrowser')) {\n  $('#facebook_search').touch(function() {\n    OF.GA.page(\"/webui/dashboard/me/friends_facebookFriends\");\n    // Note: the following facebook config is HARDCODED FOR PRODUCTION\n    // We need to fix this when we fix the whole 'we compile the haml in\n    // the development environment because we don't have node on qa or\n    // production' debacle.\n    OF.sendAction('openBrowser', {\n                  // src: 'https://graph.facebook.com/oauth/authorize?client_id=99460938373&redirect_uri=http://somedyndnsthatroutestoyourlocalhost/fbconnect/authorized&display=touch&scope=offline_access,publish_stream',\n                  src: 'https://graph.facebook.com/oauth/authorize?client_id=59872843319&redirect_uri=https://api.openfeint.com/fbconnect/authorized&display=touch&scope=offline_access,publish_stream',\n                  callback: 'OF.page.facebookDidReturn',\n                  timeout: 10000,\n                  on_failure: 'OF.page.facebookDidFailtown',\n    });\n  });\n  $('#facebook_search').show();\n}","resume":null,"appear":"$('#header .title').html(OF.page.title);\nif (OF.shouldRefreshPage){\n  OF.page.initRequest();\n  OF.friendsList.init();\n  OF.shouldRefreshPage = false;\n}","disappear":null,"exit":null,"html":"<div id='dashboard'>\n  <div id='header'>\n    <span class='loading'>\n      <span class='spinner'></span>\n    </span>\n    <div class='title' id='home_button'></div>\n  </div>\n            <script type=\"text/plain\" id=\"user_tmpl\">\n              <%\n    var style = \"\";\n    if (user.profile_picture_url) {\n      style = \"background-image: url(\" + userPicUrl(user.profile_picture_url) + \")\";\n    }\n  %>\n  \n  <li class=\"user\" data-href=\"dashboard/profile?user_id=<%= user.id %>\">\n    <div class=\"image avatar\" style=\"<%= style %>\">\n      <div class=\"overlay\"></div>\n    </div>\n    <div class=\"title user_name\"><%= user.name %></div>\n    <div class=\"feint_score\"><%= user.gamer_score %></div>\n  </li>\n            </script>\n  <div id='friends'>\n    <section id='tabbed_friend_navigation'>\n      <ul class='tabs'>\n        <li class='tab active' id='friends_tab'>\n          <div class='label'>My Friends</div>\n        </li>\n        <li class='tab' id='find_friends_tab'>\n          <div class='label'>Find Friends</div>\n        </li>\n      </ul>\n    </section>\n    <br clear='both'>\n    <div class='hidden' id='friends_search'>\n      <section id='find_friends'>\n        <h3 class='section_title'>Find Friends!</h3>\n        <div class='cell one_line' data-href='dashboard/user_search'>\n          <div class='icon'></div>\n          <div class='title'>Search by Feint Name</div>\n        </div>\n      </section>\n      <section id='facebook_search' style='display: none'>\n        <div class='cell one_line'>\n          <div class='icon'></div>\n          <div class='title'>Friends on Facebook</div>\n        </div>\n      </section>\n    </div>\n    <section id='friends_list'>\n      <section class='hidden' data-href='dashboard/friend_requests' id='requests'>\n        <h3 class='section_title'>Friend Requests</h3>\n        <div class='cell one_line'>\n          <div class='icon'></div>\n          <div class='title'></div>\n        </div>\n      </section>\n      <h3 class='section_title'>Your Friends</h3>\n      <div class='cell no_data hidden'>Find friends by importing them from Facebook or adding them by their Feint name.</div>\n      <ul class='cells'></ul>\n    </section>\n    <ul class='cells' id='loading'>\n      <li class='loading'>\n        <div class='spinner'></div>\n      </li>\n    </ul>\n  </div>\n</div>\n"}